<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Toya Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #EB3223 0%, #c72818 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header h1 {
            color: #EB3223;
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #EB3223, #c72818);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(235, 50, 35, 0.3);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #EB3223;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 1rem;
            font-weight: 600;
        }

        .filters {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .filter-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group label {
            font-weight: 600;
            color: #333;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.75rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #EB3223;
            box-shadow: 0 0 0 3px rgba(235, 50, 35, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            background: #EB3223;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn:hover {
            background: #c72818;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(235, 50, 35, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        #submissions {
            display: grid;
            gap: 1.5rem;
        }

        .submission-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .submission-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(135deg, #EB3223 0%, #c72818 100%);
        }

        .submission-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(235, 50, 35, 0.2);
        }

        .submission-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .submission-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .submission-date {
            color: #999;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .submission-status {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-new {
            background: #10b981;
            color: white;
        }

        .status-read {
            background: #3b82f6;
            color: white;
        }

        .status-replied {
            background: #8b5cf6;
            color: white;
        }

        .submission-info {
            display: grid;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-row {
            display: flex;
            gap: 0.5rem;
            align-items: start;
        }

        .info-icon {
            font-size: 1.2rem;
            min-width: 30px;
        }

        .info-label {
            font-weight: 600;
            color: #666;
            min-width: 100px;
        }

        .info-value {
            color: #333;
            flex: 1;
        }

        .info-value a {
            color: #EB3223;
            text-decoration: none;
        }

        .info-value a:hover {
            text-decoration: underline;
        }

        .submission-message {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1rem;
            line-height: 1.8;
            color: #333;
            border-right: 4px solid #EB3223;
        }

        .submission-message strong {
            color: #EB3223;
            display: block;
            margin-bottom: 0.5rem;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.5rem;
            padding: 3rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 2rem;
            border: 2px solid #ef4444;
        }

        .empty {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            padding: 3rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }

        .actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .badge-service {
            background: #dbeafe;
            color: #1e40af;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }

            .submission-header {
                flex-direction: column;
                gap: 1rem;
            }

            .actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span>ğŸ“§</span>
                Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Toya Studio
            </h1>
            <div class="header-actions">
                <button class="btn btn-success" onclick="downloadExcel()">ğŸ“Š ØªÙ†Ø²ÙŠÙ„ Excel</button>
                <button class="btn btn-success" onclick="downloadPDF()">ğŸ“„ ØªÙ†Ø²ÙŠÙ„ PDF</button>
                <a href="index.html" class="btn btn-secondary">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹</a>
                <button class="btn" onclick="loadSubmissions()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            </div>
        </div>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ†•</div>
                <div class="stat-number" id="newCount">0</div>
                <div class="stat-label">Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“…</div>
                <div class="stat-number" id="todayCount">0</div>
                <div class="stat-label">Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙŠÙˆÙ…</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ“–</div>
                <div class="stat-number" id="readCount">0</div>
                <div class="stat-label">Ø±Ø³Ø§Ø¦Ù„ Ù…Ù‚Ø±ÙˆØ¡Ø©</div>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label>Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                <select id="statusFilter">
                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                    <option value="new">Ø¬Ø¯ÙŠØ¯</option>
                    <option value="read">Ù…Ù‚Ø±ÙˆØ¡</option>
                    <option value="replied">ØªÙ… Ø§Ù„Ø±Ø¯</option>
                </select>

                <label>Ø§Ù„Ø®Ø¯Ù…Ø©:</label>
                <select id="serviceFilter">
                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</option>
                    <option value="branding">Brand Identity</option>
                    <option value="packaging">Packaging Design</option>
                    <option value="campaigns">Digital Campaigns</option>
                    <option value="production">Creative Production</option>
                    <option value="web">Web Design</option>
                    <option value="strategy">Brand Strategy</option>
                </select>

                <label>Ø§Ù„Ø¨Ø­Ø«:</label>
                <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯..." style="min-width: 200px;">

                <button class="btn" onclick="applyFilters()">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
                <button class="btn btn-secondary" onclick="resetFilters()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...
        </div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="submissions"></div>
    </div>

    <!-- jsPDF and xlsx libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, getDocs, query, orderBy, deleteDoc, doc, updateDoc } from 
            'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, onAuthStateChanged, signOut } from 
            'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        const auth = getAuth();
        let allSubmissions = [];
        let currentUser = null;

        // Check authentication status
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('âœ… User authenticated:', user.email);
                currentUser = user;
                
                // Show user email in header
                const userEmail = document.createElement('div');
                userEmail.style.cssText = `
                    color: white;
                    font-size: 0.9rem;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                `;
                userEmail.innerHTML = `
                    <span>ğŸ‘¤ ${user.email}</span>
                    <button onclick="logout()" class="btn btn-secondary btn-small" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                    </button>
                `;
                document.querySelector('.header h1').appendChild(userEmail);
                
                // Load submissions
                loadSubmissions();
            } else {
                console.log('âŒ User not authenticated, redirecting to login...');
                window.location.href = 'admin-login.html';
            }
        });

        // Logout function
        window.logout = async function() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                try {
                    await signOut(auth);
                    console.log('âœ… Logged out successfully');
                    window.location.href = 'admin-login.html';
                } catch (error) {
                    console.error('âŒ Logout error:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
                }
            }
        };

        async function loadSubmissions() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const container = document.getElementById('submissions');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            container.innerHTML = '';
            
            try {
                console.log('ğŸ“¥ Loading submissions from Firestore...');
                
                const q = query(
                    collection(db, 'contact_submissions'), 
                    orderBy('timestamp', 'desc')
                );
                
                const snapshot = await getDocs(q);
                console.log('ğŸ“Š Found', snapshot.size, 'submissions');
                
                allSubmissions = [];
                snapshot.forEach(doc => {
                    allSubmissions.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateStats();
                displaySubmissions(allSubmissions);
                loading.style.display = 'none';
                
                console.log('âœ… Submissions loaded successfully');
                
            } catch (err) {
                console.error('âŒ Error loading submissions:', err);
                loading.style.display = 'none';
                error.style.display = 'block';
                
                let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: ' + err.message;
                
                if (err.code === 'permission-denied') {
                    errorMessage = 'ğŸ”’ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.';
                } else if (err.code === 'unavailable') {
                    errorMessage = 'ğŸŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ.';
                }
                
                error.textContent = errorMessage;
            }
        }

        function updateStats() {
            const total = allSubmissions.length;
            const newCount = allSubmissions.filter(s => s.status === 'new').length;
            const readCount = allSubmissions.filter(s => s.status === 'read' || s.status === 'replied').length;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayCount = allSubmissions.filter(s => {
                const subDate = s.timestamp?.toDate ? s.timestamp.toDate() : new Date(s.createdAt);
                return subDate && subDate >= today;
            }).length;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('newCount').textContent = newCount;
            document.getElementById('todayCount').textContent = todayCount;
            document.getElementById('readCount').textContent = readCount;
        }

        function displaySubmissions(submissions) {
            const container = document.getElementById('submissions');
            
            if (submissions.length === 0) {
                container.innerHTML = '<div class="empty">ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</div>';
                return;
            }
            
            container.innerHTML = submissions.map(data => {
                const date = data.timestamp?.toDate ? data.timestamp.toDate() : new Date(data.createdAt);
                const formattedDate = date.toLocaleString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                <div class="submission-card">
                    <div class="submission-header">
                        <div>
                            <div class="submission-name">
                                <span>ğŸ‘¤</span>
                                ${data.name}
                                <span class="badge badge-service">${data.service}</span>
                            </div>
                            <div class="submission-date">ğŸ“… ${formattedDate}</div>
                        </div>
                        <span class="submission-status status-${data.status || 'new'}">${getStatusText(data.status || 'new')}</span>
                    </div>
                    
                    <div class="submission-info">
                        <div class="info-row">
                            <span class="info-icon">ğŸ“§</span>
                            <span class="info-label">Ø§Ù„Ø¨Ø±ÙŠØ¯:</span>
                            <span class="info-value"><a href="mailto:${data.email}">${data.email}</a></span>
                        </div>
                        ${data.company ? `
                        <div class="info-row">
                            <span class="info-icon">ğŸ¢</span>
                            <span class="info-label">Ø§Ù„Ø´Ø±ÙƒØ©:</span>
                            <span class="info-value">${data.company}</span>
                        </div>
                        ` : ''}
                        <div class="info-row">
                            <span class="info-icon">ğŸ¯</span>
                            <span class="info-label">Ø§Ù„Ø®Ø¯Ù…Ø©:</span>
                            <span class="info-value">${getServiceName(data.service)}</span>
                        </div>
                    </div>
                    
                    <div class="submission-message">
                        <strong>ğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</strong>
                        ${data.message}
                    </div>
                    
                    <div class="actions">
                        <button class="btn btn-success btn-small" onclick="markAsRead('${data.id}')">
                            âœ“ ØªØ­Ø¯ÙŠØ¯ ÙƒÙ…Ù‚Ø±ÙˆØ¡
                        </button>
                        <button class="btn btn-small" onclick="markAsReplied('${data.id}')">
                            âœ‰ï¸ ØªÙ… Ø§Ù„Ø±Ø¯
                        </button>
                        <a href="mailto:${data.email}" class="btn btn-small">
                            ğŸ“§ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯
                        </a>
                        <button class="btn btn-danger btn-small" onclick="deleteSubmission('${data.id}')">
                            ğŸ—‘ï¸ Ø­Ø°Ù
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'new': 'ğŸ†• Ø¬Ø¯ÙŠØ¯',
                'read': 'ğŸ“– Ù…Ù‚Ø±ÙˆØ¡',
                'replied': 'âœ… ØªÙ… Ø§Ù„Ø±Ø¯'
            };
            return statusMap[status] || status;
        }

        function getServiceName(service) {
            const serviceMap = {
                'branding': 'Brand Identity - Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©',
                'packaging': 'Packaging Design - ØªØµÙ…ÙŠÙ… Ø§Ù„ØªØºÙ„ÙŠÙ',
                'campaigns': 'Digital Campaigns - Ø§Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©',
                'production': 'Creative Production - Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ÙŠ',
                'web': 'Web Design - ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹',
                'strategy': 'Brand Strategy - Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©'
            };
            return serviceMap[service] || service;
        }

        window.applyFilters = function() {
            const statusFilter = document.getElementById('statusFilter').value;
            const serviceFilter = document.getElementById('serviceFilter').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = allSubmissions;
            
            if (statusFilter !== 'all') {
                filtered = filtered.filter(s => s.status === statusFilter);
            }
            
            if (serviceFilter !== 'all') {
                filtered = filtered.filter(s => s.service === serviceFilter);
            }
            
            if (searchText) {
                filtered = filtered.filter(s => 
                    s.name.toLowerCase().includes(searchText) ||
                    s.email.toLowerCase().includes(searchText) ||
                    (s.company && s.company.toLowerCase().includes(searchText))
                );
            }
            
            displaySubmissions(filtered);
        };

        window.resetFilters = function() {
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('serviceFilter').value = 'all';
            document.getElementById('searchInput').value = '';
            displaySubmissions(allSubmissions);
        };

        window.markAsRead = async function(id) {
            try {
                await updateDoc(doc(db, 'contact_submissions', id), {
                    status: 'read'
                });
                console.log('âœ… Marked as read:', id);
                await loadSubmissions();
            } catch (err) {
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: ' + err.message);
            }
        };

        window.markAsReplied = async function(id) {
            try {
                await updateDoc(doc(db, 'contact_submissions', id), {
                    status: 'replied'
                });
                console.log('âœ… Marked as replied:', id);
                await loadSubmissions();
            } catch (err) {
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©: ' + err.message);
            }
        };

        window.deleteSubmission = async function(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'contact_submissions', id));
                console.log('âœ… Deleted submission:', id);
                await loadSubmissions();
            } catch (err) {
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ' + err.message);
            }
        };

        window.loadSubmissions = loadSubmissions;
        
        // Download as Excel
        window.downloadExcel = function() {
            if (allSubmissions.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªÙ†Ø²ÙŠÙ„');
                return;
            }
            
            try {
                // Prepare data for Excel
                const excelData = allSubmissions.map(sub => {
                    const date = sub.timestamp?.toDate ? sub.timestamp.toDate() : new Date(sub.createdAt);
                    return {
                        'Ø§Ù„ØªØ§Ø±ÙŠØ®': date.toLocaleString('ar-EG'),
                        'Ø§Ù„Ø§Ø³Ù…': sub.name,
                        'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ': sub.email,
                        'Ø§Ù„Ø´Ø±ÙƒØ©': sub.company || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        'Ø§Ù„Ø®Ø¯Ù…Ø©': getServiceName(sub.service),
                        'Ø§Ù„Ø­Ø§Ù„Ø©': getStatusText(sub.status || 'new'),
                        'Ø§Ù„Ø±Ø³Ø§Ù„Ø©': sub.message
                    };
                });
                
                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Set column widths
                ws['!cols'] = [
                    { wch: 20 }, // Ø§Ù„ØªØ§Ø±ÙŠØ®
                    { wch: 20 }, // Ø§Ù„Ø§Ø³Ù…
                    { wch: 30 }, // Ø§Ù„Ø¨Ø±ÙŠØ¯
                    { wch: 20 }, // Ø§Ù„Ø´Ø±ÙƒØ©
                    { wch: 30 }, // Ø§Ù„Ø®Ø¯Ù…Ø©
                    { wch: 15 }, // Ø§Ù„Ø­Ø§Ù„Ø©
                    { wch: 50 }  // Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ø±Ø³Ø§Ø¦Ù„');
                
                // Generate filename with date
                const filename = `Toya-Studio-Messages-${new Date().toISOString().split('T')[0]}.xlsx`;
                
                // Download
                XLSX.writeFile(wb, filename);
                
                console.log('âœ… Excel file downloaded:', filename);
                
                // Show success message
                showDownloadSuccess('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Excel Ø¨Ù†Ø¬Ø§Ø­');
                
            } catch (error) {
                console.error('âŒ Error creating Excel:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel: ' + error.message);
            }
        };
        
        // Download as PDF with Arabic support
        window.downloadPDF = function() {
            if (allSubmissions.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªÙ†Ø²ÙŠÙ„');
                return;
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4'); // landscape orientation
                
                // Set font for better Arabic support
                doc.setFont('helvetica');
                
                // Add header with logo area
                doc.setFillColor(235, 50, 35);
                doc.rect(0, 0, doc.internal.pageSize.getWidth(), 35, 'F');
                
                // Add title in white
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.text('Toya Studio', 15, 15);
                
                doc.setFontSize(14);
                doc.text('Contact Messages Report', 15, 25);
                
                // Add date and stats
                doc.setFontSize(10);
                const totalCount = allSubmissions.length;
                const newCount = allSubmissions.filter(s => s.status === 'new').length;
                doc.text(`Generated: ${new Date().toLocaleString('ar-EG')}`, doc.internal.pageSize.getWidth() - 15, 15, { align: 'right' });
                doc.text(`Total: ${totalCount} | New: ${newCount}`, doc.internal.pageSize.getWidth() - 15, 25, { align: 'right' });
                
                // Reset text color for table
                doc.setTextColor(0, 0, 0);
                
                // Prepare table data with Arabic text handling
                const tableData = allSubmissions.map((sub, index) => {
                    const date = sub.timestamp?.toDate ? sub.timestamp.toDate() : new Date(sub.createdAt);
                    const formattedDate = date.toLocaleDateString('ar-EG', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    
                    // Get service name in Arabic
                    const serviceNames = {
                        'branding': 'Brand Identity',
                        'packaging': 'Packaging Design',
                        'campaigns': 'Digital Campaigns',
                        'production': 'Creative Production',
                        'web': 'Web Design',
                        'strategy': 'Brand Strategy'
                    };
                    
                    // Get status in Arabic
                    const statusNames = {
                        'new': 'New',
                        'read': 'Read',
                        'replied': 'Replied'
                    };
                    
                    return [
                        (index + 1).toString(),
                        formattedDate,
                        sub.name || '',
                        sub.email || '',
                        sub.company || '-',
                        serviceNames[sub.service] || sub.service,
                        statusNames[sub.status] || sub.status || 'new',
                        (sub.message || '').substring(0, 80) + ((sub.message || '').length > 80 ? '...' : '')
                    ];
                });
                
                // Add table with enhanced styling
                doc.autoTable({
                    head: [['#', 'Date', 'Name', 'Email', 'Company', 'Service', 'Status', 'Message']],
                    body: tableData,
                    startY: 40,
                    styles: {
                        fontSize: 8,
                        cellPadding: 3,
                        lineColor: [220, 220, 220],
                        lineWidth: 0.1,
                        font: 'helvetica'
                    },
                    headStyles: {
                        fillColor: [235, 50, 35],
                        textColor: 255,
                        fontStyle: 'bold',
                        fontSize: 9,
                        halign: 'center'
                    },
                    alternateRowStyles: {
                        fillColor: [250, 250, 250]
                    },
                    columnStyles: {
                        0: { cellWidth: 10, halign: 'center' },  // #
                        1: { cellWidth: 25, halign: 'center' },  // Date
                        2: { cellWidth: 30 },                     // Name
                        3: { cellWidth: 45 },                     // Email
                        4: { cellWidth: 25 },                     // Company
                        5: { cellWidth: 35 },                     // Service
                        6: { cellWidth: 20, halign: 'center' },  // Status
                        7: { cellWidth: 'auto' }                  // Message
                    },
                    didDrawCell: function(data) {
                        // Color code status column
                        if (data.column.index === 6 && data.section === 'body') {
                            const status = tableData[data.row.index][6];
                            if (status === 'New') {
                                doc.setFillColor(16, 185, 129);
                                doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                                doc.setTextColor(255, 255, 255);
                                doc.text(status, data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2, { 
                                    align: 'center',
                                    baseline: 'middle'
                                });
                            } else if (status === 'Read') {
                                doc.setFillColor(59, 130, 246);
                                doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                                doc.setTextColor(255, 255, 255);
                                doc.text(status, data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2, { 
                                    align: 'center',
                                    baseline: 'middle'
                                });
                            } else if (status === 'Replied') {
                                doc.setFillColor(139, 92, 246);
                                doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                                doc.setTextColor(255, 255, 255);
                                doc.text(status, data.cell.x + data.cell.width / 2, data.cell.y + data.cell.height / 2, { 
                                    align: 'center',
                                    baseline: 'middle'
                                });
                            }
                        }
                    }
                });
                
                // Add footer with page numbers and company info
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    
                    // Footer line
                    doc.setDrawColor(235, 50, 35);
                    doc.setLineWidth(0.5);
                    doc.line(15, doc.internal.pageSize.getHeight() - 15, doc.internal.pageSize.getWidth() - 15, doc.internal.pageSize.getHeight() - 15);
                    
                    // Page number
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text(
                        `Page ${i} of ${pageCount}`,
                        doc.internal.pageSize.getWidth() / 2,
                        doc.internal.pageSize.getHeight() - 10,
                        { align: 'center' }
                    );
                    
                    // Company info
                    doc.text(
                        'Toya Studio | sales@toya-studio.com | +20 1116111860',
                        15,
                        doc.internal.pageSize.getHeight() - 10
                    );
                }
                
                // Generate filename with date
                const filename = `Toya-Studio-Messages-${new Date().toISOString().split('T')[0]}.pdf`;
                
                // Download
                doc.save(filename);
                
                console.log('âœ… PDF file downloaded:', filename);
                
                // Show success message
                showDownloadSuccess('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù PDF Ø¨Ù†Ø¬Ø§Ø­');
                
            } catch (error) {
                console.error('âŒ Error creating PDF:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF: ' + error.message);
            }
        };
        
        // Show download success message
        function showDownloadSuccess(message) {
            const successMsg = document.createElement('div');
            successMsg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 1rem 2rem;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
                z-index: 10001;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            successMsg.textContent = message;
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                successMsg.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => successMsg.remove(), 300);
            }, 3000);
        }
        
        // Load on page load
        loadSubmissions();
        
        // Auto-refresh every 30 seconds
        setInterval(loadSubmissions, 30000);
    </script>
    
    <style>
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</body>
</html>
